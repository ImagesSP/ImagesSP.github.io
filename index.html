<script src="https://www.google.com/recaptcha/api.js?render=6LfuIlMsAAAAAIBNibPY3-PKAYbN_sC3G70kpKVM"></script>

<script>
  const form = document.getElementById("contactForm");
  const popup = document.getElementById("formSuccess");

  form.addEventListener("submit", function (e) {
    e.preventDefault();

    grecaptcha.execute('6LfuIlMsAAAAAIBNibPY3-PKAYbN_sC3G70kpKVM', {action: 'submit'})
      .then(function(token) {

        // Build a plain JS object instead of FormData
        const data = {};
        const formData = new FormData(form);
        formData.forEach((value, key) => {
          data[key] = value;
        });

        // Add the fresh token
        data.recaptchaToken = token;

        fetch(form.action, {
          method: "POST",
          headers: {
            "Content-Type": "text/plain;charset=utf-8"
          },
          body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(res => {
          if (res.status === "success") {
            form.reset();
            popup.classList.add("show");
            setTimeout(() => popup.classList.remove("show"), 3000);
          } else {
            alert("Blocked as spam.");
          }
        })
        .catch(err => {
          console.error(err);
          alert("Something went wrong.");
        });
      });
  });
</script>
